## å¤šçº¿ç¨‹

å¦‚æœä¸è€ƒè™‘å…¶ä»–ä»»ä½•å› ç´ å’ŒæŠ€æœ¯ï¼Œå¤šçº¿ç¨‹æœ‰ç™¾å®³è€Œæ— ä¸€åˆ©ï¼Œåªèƒ½æµªè´¹æ—¶é—´ï¼Œé™ä½ç¨‹åºæ•ˆç‡ã€‚

æ˜¯çš„ï¼Œæˆ‘å¾ˆæ¸…é†’çš„å†™ä¸‹è¿™å¥è¯ã€‚

è¯•æƒ³ä¸€ä¸‹ï¼Œä¸€ä¸ªä»»åŠ¡ç”±åä¸ªå­ä»»åŠ¡ç»„æˆã€‚ç°åœ¨æœ‰ä¸¤ç§æ–¹å¼å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼š

> 1. å»ºåä¸ªçº¿ç¨‹ï¼ŒæŠŠæ¯ä¸ªå­ä»»åŠ¡æ”¾åœ¨å¯¹åº”çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚æ‰§è¡Œå®Œä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»»åŠ¡å°±åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚
2. æŠŠåä¸ªä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œï¼ŒæŒ‰é¡ºåºæ‰§è¡Œã€‚

```
æ“ä½œç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ï¼šçº¿ç¨‹ï¼Œæ˜¯æ‰§è¡Œç¨‹åºæœ€åŸºæœ¬çš„å•å…ƒï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆå’Œå¯„å­˜å™¨ã€‚å…·ä½“äº›ï¼Œçº¿ç¨‹å°±æ˜¯â€œä¸€ä¸ªCPUæ‰§è¡Œçš„ä¸€æ¡æ— åˆ†å‰çš„å‘½ä»¤åˆ—â€
```

> å¯¹äºç¬¬ä¸€ç§æ–¹æ³•ï¼Œåœ¨åä¸ªçº¿ç¨‹ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œå°±æ„å‘³ç€æœ‰åç»„æ ˆå’Œå¯„å­˜å™¨ä¸­çš„å€¼éœ€è¦ä¸æ–­åœ°è¢«å¤‡ä»½ã€æ›¿æ¢ã€‚ è€Œå¯¹äºå¯¹äºç¬¬äºŒç§æ–¹æ³•ï¼Œåªæœ‰ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆå­˜åœ¨ï¼Œæ˜¾ç„¶æ•ˆç‡å®Œèƒœå‰è€…ã€‚

### å¹¶å‘ & å¹¶è¡Œ

é€šè¿‡åˆšæ‰çš„åˆ†æï¼Œå¤šçº¿ç¨‹æœ¬èº«ä¼šå¸¦æ¥æ•ˆç‡ä¸Šçš„æŸå¤±ã€‚å‡†ç¡®æ¥è¯´ï¼Œåœ¨å¤„ç†å¹¶å‘ä»»åŠ¡æ—¶ï¼Œå¤šçº¿ç¨‹ä¸ä»…ä¸èƒ½æé«˜æ•ˆç‡ï¼Œåè€Œè¿˜ä¼šé™ä½ç¨‹åºæ•ˆç‡ã€‚

æ‰€è°“çš„`å¹¶å‘ï¼ˆconcurrentï¼‰`ï¼Œè¦æ³¨æ„å’Œ`å¹¶è¡Œï¼ˆparallelismï¼‰`çš„åŒºåˆ«ã€‚

> `å¹¶å‘`æŒ‡çš„æ˜¯ä¸€ç§ç°è±¡ï¼Œä¸€ç§ç»å¸¸å‡ºç°ï¼Œæ— å¯é¿å…çš„ç°è±¡ã€‚å®ƒæè¿°çš„æ˜¯`å¤šä¸ªä»»åŠ¡åŒæ—¶å‘ç”Ÿï¼Œéœ€è¦è¢«å¤„ç†`è¿™ä¸€ç°è±¡ã€‚å®ƒçš„ä¾§é‡ç‚¹åœ¨äº`å‘ç”Ÿ`ã€‚

æ¯”å¦‚æœ‰å¾ˆå¤šäººæ’é˜Ÿç­‰å¾…æ£€ç¥¨ï¼Œè¿™ä¸€ç°è±¡å°±å¯ä»¥ç†è§£ä¸ºå¹¶å‘ã€‚

> `å¹¶è¡Œ`æŒ‡çš„æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œä¸€ä¸ªåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡çš„æŠ€æœ¯ã€‚å®ƒæè¿°äº†`ä¸€ç§èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›`ï¼Œä¾§é‡ç‚¹åœ¨äº`è¿è¡Œ`ã€‚

æ¯”å¦‚æ™¯ç‚¹å¼€æ”¾äº†å¤šä¸ªæ£€ç¥¨çª—å£ï¼ŒåŒä¸€æ—¶é—´å†…èƒ½æœåŠ¡å¤šä¸ªæ¸¸å®¢ã€‚è¿™ç§æƒ…å†µå¯ä»¥ç†è§£ä¸ºå¹¶è¡Œã€‚

å¹¶è¡Œçš„åä¹‰è¯å°±æ˜¯`ä¸²è¡Œ`ï¼Œè¡¨ç¤ºä»»åŠ¡å¿…é¡»æŒ‰é¡ºåºæ¥ï¼Œä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œï¼Œå‰ä¸€ä¸ªæ‰§è¡Œå®Œäº†æ‰èƒ½æ‰§è¡Œåä¸€ä¸ªã€‚

> `å¤šçº¿ç¨‹` å°±æ˜¯é‡‡ç”¨äº† `å¹¶è¡Œ` è¿™ç§æŠ€æœ¯ï¼Œä»è€Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œå› ä¸ºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥è®¡ç®—æœºçš„å¤šä¸ªCPUå¯ä»¥åŒæ—¶å·¥ä½œï¼ŒåŒæ—¶å¤„ç†ä¸åŒçº¿ç¨‹å†…çš„æŒ‡ä»¤ã€‚

### å°ç»“

```
`å¹¶å‘`æ˜¯ä¸€ç§ç°è±¡ï¼Œé¢å¯¹è¿™ä¸€ç°è±¡ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼ŒçœŸæ­£åŠ å¿«ç¨‹åºè¿è¡Œé€Ÿåº¦çš„ï¼Œæ˜¯`å¹¶è¡Œ`æŠ€æœ¯ã€‚ä¹Ÿå°±æ˜¯è®©å¤šä¸ªCPUåŒæ—¶å·¥ä½œã€‚è€Œå¤šçº¿ç¨‹ï¼Œæ˜¯ä¸ºäº†è®©å¤šä¸ªCPUåŒæ—¶å·¥ä½œæˆä¸ºå¯èƒ½ã€‚
```

### åŒæ­¥ & å¼‚æ­¥

> `åŒæ­¥` å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è°ƒç”¨çš„å“ªäº›æ–¹æ³•ã€‚æ¯”å¦‚åœ¨ç¬¬ä¸€è¡Œè°ƒç”¨`foo()`æ–¹æ³•ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œåˆ°ç¬¬äºŒè¡Œçš„æ—¶å€™ï¼Œfooæ–¹æ³•è‚¯å®šæ˜¯æ‰§è¡Œå®Œäº†ã€‚

> `å¼‚æ­¥` å°±æ˜¯å…è®¸åœ¨æ‰§è¡ŒæŸä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œå‡½æ•°ç«‹åˆ»è¿”å›ï¼Œä½†æ˜¯çœŸæ­£è¦æ‰§è¡Œçš„ä»»åŠ¡ç¨åå®Œæˆã€‚

æ¯”å¦‚æˆ‘ä»¬åœ¨ç‚¹å‡»ä¿å­˜æŒ‰é’®ä¹‹åï¼Œè¦å…ˆæŠŠæ•°æ®å†™åˆ°ç£ç›˜ï¼Œç„¶åæ›´æ–°UIã€‚åŒæ­¥æ–¹æ³•å°±æ˜¯ç­‰åˆ°æ•°æ®ä¿å­˜å®Œå†æ›´æ–°UIï¼Œè€Œå¼‚æ­¥åˆ™æ˜¯ç«‹åˆ»ä»ä¿å­˜æ•°æ®çš„æ–¹æ³•è¿”å›å¹¶å‘åæ‰§è¡Œä»£ç ï¼ŒåŒæ—¶çœŸæ­£ç”¨æ¥ä¿å­˜æ•°æ®çš„æŒ‡ä»¤å°†åœ¨ç¨åæ‰§è¡Œã€‚

#### åŒºåˆ« & è”ç³»

###### åŒºåˆ«

```
å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªä»»åŠ¡éœ€è¦å¤„ç†ã€‚å‡è®¾å•ä¸ªCPUå¤„ç†å®ƒä»¬åˆ†åˆ«éœ€è¦3ã€1ã€1ç§’ã€‚

`å¹¶è¡Œ`ä¸`ä¸²è¡Œ`ï¼Œå…¶å®è®¨è®ºçš„æ˜¯å¤„ç†è¿™ä¸‰ä¸ªä»»åŠ¡çš„é€Ÿåº¦é—®é¢˜ã€‚å¦‚æœä¸‰ä¸ªCPU`å¹¶è¡Œ`å¤„ç†ï¼Œé‚£ä¹ˆä¸€å…±åªéœ€è¦3ç§’ã€‚ç›¸æ¯”äº`ä¸²è¡Œ`å¤„ç†ï¼ŒèŠ‚çº¦äº†2ç§’ã€‚

`åŒæ­¥`ä¸`å¼‚æ­¥`ï¼Œå…¶å®æè¿°çš„æ˜¯ä»»åŠ¡ä¹‹é—´å…ˆåé¡ºåºé—®é¢˜ã€‚å‡è®¾éœ€è¦ä¸‰ç§’çš„é‚£ä¸ªæ˜¯ä¿å­˜æ•°æ®çš„ä»»åŠ¡ï¼Œè€Œå¦å¤–ä¸¤ä¸ªæ˜¯UIç›¸å…³çš„ä»»åŠ¡ã€‚é‚£ä¹ˆé€šè¿‡å¼‚æ­¥æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬çœå»äº†3ç§’é’Ÿçš„å¡é¡¿æ—¶é—´ã€‚
```

###### è”ç³»

```
å¯¹äº`åŒæ­¥æ‰§è¡Œ`çš„ä¸‰ä¸ªä»»åŠ¡æ¥è¯´ï¼Œç³»ç»Ÿ`å€¾å‘äº`åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå®ƒä»¬ã€‚å› ä¸ºå³ä½¿å¼€äº†ä¸‰ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¾—ç­‰ä»–ä»¬åˆ†åˆ«åœ¨å„è‡ªçš„çº¿ç¨‹ä¸­å®Œæˆã€‚å¹¶ä¸èƒ½å‡å°‘æ€»çš„å¤„ç†æ—¶é—´ï¼Œåè€Œå¾’å¢äº†çº¿ç¨‹åˆ‡æ¢ã€‚

å¯¹äº`å¼‚æ­¥æ‰§è¡Œ`çš„ä¸‰ä¸ªä»»åŠ¡æ¥è¯´ï¼Œç³»ç»Ÿ`å€¾å‘äº`åœ¨ä¸‰ä¸ªæ–°çš„çº¿ç¨‹é‡Œæ‰§è¡Œä»–ä»¬ã€‚å› ä¸ºè¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦çš„åˆ©ç”¨CPUæ€§èƒ½ï¼Œæå‡ç¨‹åºè¿è¡Œæ•ˆç‡ã€‚
```

### å°ç»“

```
ç”±æ­¤å¾—å‡ºç»“è®ºï¼Œåœ¨éœ€è¦åŒæ—¶å¤„ç†IOå’ŒUIçš„æƒ…å†µä¸‹ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯å¼‚æ­¥ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ã€‚å¯ä»¥ä¸ç”¨å¤šçº¿ç¨‹ï¼ˆå› ä¸ºå¤„ç†UIéå¸¸å¿«ï¼‰ï¼Œä½†ä¸èƒ½ä¸ç”¨å¼‚æ­¥ï¼ˆå¦åˆ™çš„è¯è‡³å°‘è¦ç­‰IOç»“æŸï¼‰ã€‚
æ³¨æ„åˆ°æˆ‘æŠŠâ€œå€¾å‘äºâ€è¿™ä¸‰ä¸ªåŠ ç²—äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å¼‚æ­¥æ–¹æ³•å¹¶ä¸ä¸€å®šæ°¸è¿œåœ¨æ–°çº¿ç¨‹é‡Œé¢æ‰§è¡Œï¼Œåä¹‹äº¦ç„¶ã€‚åœ¨æ¥ä¸‹æ¥å…³äºGCDçš„éƒ¨åˆ†ä¼šå¯¹æ­¤åšå‡ºè§£é‡Šã€‚
```

## GCD

### 1. GCD ç®€ä»‹

`GCD` ä»¥ `block` ä¸ºåŸºæœ¬å•ä½ï¼Œä¸€ä¸ª `block` ä¸­çš„ä»£ç å¯ä»¥ä¸ºä¸€ä¸ªä»»åŠ¡ã€‚ä¸‹æ–‡ä¸­æåˆ°ä»»åŠ¡ï¼Œå¯ä»¥ç†è§£ä¸ºæ‰§è¡ŒæŸä¸ª `block`ã€‚

åŒæ—¶ï¼Œ`GCD` ä¸­æœ‰ä¸¤å¤§æœ€é‡è¦çš„æ¦‚å¿µï¼š

- é˜Ÿåˆ—
- æ‰§è¡Œæ–¹å¼

ä½¿ç”¨ `block` çš„è¿‡ç¨‹ï¼Œæ¦‚æ‹¬æ¥è¯´å°±æ˜¯æŠŠ `block` æ”¾è¿›åˆé€‚çš„é˜Ÿåˆ—ï¼Œå¹¶é€‰æ‹©åˆé€‚çš„æ‰§è¡Œæ–¹å¼å»æ‰§è¡Œ `block` çš„è¿‡ç¨‹ã€‚

#### é˜Ÿåˆ—å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š

- ä¸²è¡Œé˜Ÿåˆ—ï¼šå…ˆè¿›å…ˆå‡ºï¼Œä¹Ÿå°±æ˜¯å…ˆè¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡å…ˆå‡ºé˜Ÿåˆ—ï¼Œæ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡
- å¹¶è¡Œé˜Ÿåˆ—ï¼šå…ˆè¿›å…ˆå‡ºï¼Œä½†å¯ä»¥å½¢æˆå¤šä¸ªä»»åŠ¡å¹¶å‘
- ä¸»é˜Ÿåˆ—ï¼šä¸€ä¸ªç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œè€Œä¸”é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€å®šä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ

#### æ‰§è¡Œæ–¹å¼æœ‰ä¸€ä¸‹ä¸¤ç§åŸºæœ¬æ–¹å¼ï¼š

- åŒæ­¥æ‰§è¡Œ
- å¼‚æ­¥æ‰§è¡Œ

å…³äºåŒæ­¥å¼‚æ­¥ã€å¹¶è¡Œä¸²è¡Œå’Œçº¿ç¨‹çš„å…³ç³»ï¼Œå¯ä»¥ç”±ä¸‹è¡¨æ¦‚æ‹¬ï¼š

/Users/tao/Desktop/1.png

å¯ä»¥çœ‹åˆ°ï¼ŒåŒæ­¥æ–¹æ³•ä¸ä¸€å®šåœ¨æœ¬çº¿ç¨‹ï¼Œå¼‚æ­¥æ–¹æ³•æ–¹æ³•ä¹Ÿä¸ä¸€å®šæ–°å¼€çº¿ç¨‹ï¼ˆè€ƒè™‘ä¸»é˜Ÿåˆ—ï¼‰ã€‚

ç„¶è€Œäº‹å®ä¸Šï¼Œåœ¨æœ¬æ–‡ä¸€å¼€å§‹å°±æ­å¼€äº†â€œå¤šçº¿ç¨‹â€çš„ç¥ç§˜é¢çº±ï¼Œæ‰€ä»¥åœ¨ç¼–ç¨‹æ—¶ï¼Œæ›´åº”è¯¥è€ƒè™‘çš„æ˜¯ï¼š

> åŒæ­¥ or å¼‚æ­¥

ä»¥åŠ

> å¹¶è¡Œ or ä¸²è¡Œ

è€Œéä»…ä»…è€ƒè™‘æ˜¯å¦æ–°å¼€çº¿ç¨‹ã€‚

å½“ç„¶ï¼Œäº†è§£ä»»åŠ¡è¿è¡Œåœ¨é‚£ä¸ªçº¿ç¨‹ä¸­ä¹Ÿæ˜¯ä¸ºäº†æ›´åŠ æ·±å…¥çš„ç†è§£æ•´ä¸ªç¨‹åºçš„è¿è¡Œæƒ…å†µï¼Œå°¤å…¶æ˜¯æ¥ä¸‹æ¥è¦è®¨è®ºçš„æ­»é”é—®é¢˜ã€‚

### 2. GCD æ­»é”é—®é¢˜

åœ¨ä½¿ç”¨GCDçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ `å‘å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­åŒæ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡`ï¼Œå°±ä¼šå¯¼è‡´æ­»é”ã€‚

ä¸¾ä¸ªğŸŒ°è§£é‡Šä¸€ä¸‹ï¼š

```
dispatch_queue_t mainQueue = dispatch_get_main_queue();

id block = ^{
NSLog(@"%@", [NSThread currentThread]);
};

// å‘å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­åŒæ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡, æ­»é”
dispatch_sync(mainQueue, block);
```

è¿™æ®µä»£ç å°±ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºæˆ‘ä»¬ç›®å‰åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œåˆå°†è¦åŒæ­¥åœ°æ·»åŠ ä¸€ä¸ª `block` åˆ°ä¸»é˜Ÿåˆ—(ä¸²è¡Œ)ä¸­ã€‚

#### ç†è®ºåˆ†æ

```
æˆ‘ä»¬çŸ¥é“ `dispatch_sync` è¡¨ç¤ºåŒæ­¥çš„æ‰§è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œ `dispatch_sync` åï¼Œå½“å‰é˜Ÿåˆ—ä¼šé˜»å¡ã€‚è€Œ`dispatch_sync` ä¸­çš„blockå¦‚æœè¦åœ¨å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œå°±å¾—ç­‰å¾…å½“å‰é˜Ÿåˆ—ç¨‹æ‰§è¡Œå®Œæˆã€‚

åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸»é˜Ÿåˆ—åœ¨æ‰§è¡Œ `dispatch_sync`ï¼Œéšåé˜Ÿåˆ—ä¸­æ–°å¢ä¸€ä¸ªä»»åŠ¡ `block`ã€‚å› ä¸ºä¸»é˜Ÿåˆ—æ˜¯åŒæ­¥é˜Ÿåˆ—ï¼Œæ‰€ä»¥`block` è¦ç­‰ `dispatch_sync` æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œä½†æ˜¯ `dispatch_sync` æ˜¯åŒæ­¥æ´¾å‘ï¼Œè¦ç­‰ `block` æ‰§è¡Œå®Œæ‰ç®—æ˜¯ç»“æŸã€‚åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä¸¤ä¸ªä»»åŠ¡äº’ç›¸ç­‰å¾…ï¼Œå¯¼è‡´äº†æ­»é”ã€‚
```

#### è§£å†³æ–¹æ¡ˆ

```
å…¶å®åœ¨é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸å¿…è¦ç”¨ `dispatch_sync`ï¼Œå› ä¸º `dispatch_async` èƒ½å¤Ÿæ›´å¥½çš„åˆ©ç”¨CPUï¼Œæå‡ç¨‹åºè¿è¡Œé€Ÿåº¦ã€‚
åªæœ‰å½“æˆ‘ä»¬éœ€è¦ä¿è¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¿…é¡»é¡ºåºæ‰§è¡Œæ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ `dispatch_sync`ã€‚åœ¨ä½¿ç”¨ `dispatch_sync` çš„æ—¶å€™åº”è¯¥åˆ†æå½“å‰å¤„äºå“ªä¸ªé˜Ÿåˆ—ï¼Œä»¥åŠä»»åŠ¡ä¼šæäº¤åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚
```

### 3. GCD å¸¸ç”¨å‡½æ•°

#### dispatch_group

äº†è§£å®Œé˜Ÿåˆ—ä¹‹åï¼Œå¾ˆè‡ªç„¶çš„ä¼šæœ‰ä¸€ä¸ªæƒ³æ³•ï¼šæˆ‘ä»¬æ€ä¹ˆçŸ¥é“æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»æ‰§è¡Œå®Œäº†å‘¢ï¼Ÿ

åœ¨å•ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºåªè¦æŠŠå›è°ƒ `block` æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾å³å¯ã€‚

ä½†æ˜¯å¯¹äºå¹¶è¡Œé˜Ÿåˆ—ï¼Œä»¥åŠå¤šä¸ªä¸²è¡Œã€å¹¶è¡Œé˜Ÿåˆ—æ··åˆçš„æƒ…å†µï¼Œå°±éœ€è¦ä½¿ç”¨ `dispatch_group` äº†ã€‚

```
// åˆ›å»ºçº¿ç¨‹ç»„
dispatch_group_t group = dispatch_group_create();
dispatch_queue_t serialQueue = dispatch_queue_create("serialQueue", DISPATCH_QUEUE_SERIAL);

// ç»„å¼‚æ­¥æ‰§è¡Œ
dispatch_group_async(group, serialQueue, ^{
for (int i = 0; i < 2; i++) {
NSLog(@"group-serial - %@", [NSThread currentThread]);
}
});

dispatch_group_async(group, serialQueue, ^{
for (int i = 0; i < 3; i++) {
NSLog(@"group-02-serial - %@", [NSThread currentThread]);
}
});

// æŠŠç¬¬ä¸‰ä¸ªå‚æ•°blockä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°é˜Ÿåˆ—ä¸­å»ã€‚
// è€Œä¸”å¯ä»¥ä¿è¯ç¬¬ä¸‰ä¸ªå‚æ•°blockæ‰§è¡Œæ—¶ï¼Œgroupä¸­çš„æ‰€æœ‰ä»»åŠ¡å·²ç»å…¨éƒ¨å®Œæˆ
dispatch_group_notify(group, serialQueue, ^{
NSLog(@"Finished - %@", [NSThread currentThread]);
});
```

###### dispatch_group_wait

`dispatch_group_wait(group: dispatch_group_t, _ timeout: dispatch_time_t) -> Int`

ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºè¦ç­‰å¾…çš„groupï¼Œç¬¬äºŒä¸ªåˆ™è¡¨ç¤ºç­‰å¾…æ—¶é—´ã€‚è¿”å›å€¼è¡¨ç¤ºç»è¿‡æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œå±äºè¿™ä¸ªgroupçš„ä»»åŠ¡æ˜¯å¦å·²ç»å…¨éƒ¨æ‰§è¡Œå®Œï¼Œå¦‚æœæ˜¯åˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›é0ã€‚

ç¬¬äºŒä¸ª `dispatch_time_t` ç±»å‹çš„å‚æ•°è¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼š`DISPATCH_TIME_NOW` å’Œ `DISPATCH_TIME_FOREVER`ã€‚


#### barrier

- é€šè¿‡ `dispatch_barrier_async` æ·»åŠ çš„blockä¼šç­‰åˆ°ä¹‹å‰æ·»åŠ æ‰€æœ‰çš„blockæ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œ
- åœ¨ `dispatch_barrier_async` ä¹‹åæ·»åŠ çš„blockä¼šç­‰åˆ° `dispatch_barrier_async` æ·»åŠ çš„blockæ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œ

```
- (void)barrier {
dispatch_queue_t queue = dispatch_queue_create("net.bujige.testQueue", DISPATCH_QUEUE_CONCURRENT);
dispatch_async(queue, ^{
// dosth1;
});
dispatch_async(queue, ^{
// dosth2;
});
dispatch_barrier_async(queue, ^{
// doBarrier;
});
dispatch_async(queue, ^{
// dosth4;
});
dispatch_async(queue, ^{
// dosth5;
});
}
```

#### ä¿¡å·é‡ (dispatch_semaphore)

å½“æˆ‘ä»¬å¤šä¸ªçº¿ç¨‹è¦è®¿é—®åŒä¸€ä¸ªèµ„æºçš„æ—¶å€™ï¼Œå¾€å¾€ä¼šè®¾ç½®ä¸€ä¸ªä¿¡å·é‡ï¼Œå½“ä¿¡å·é‡å¤§äº0çš„æ—¶å€™ï¼Œæ–°çš„çº¿ç¨‹å¯ä»¥å»æ“ä½œè¿™ä¸ªèµ„æºï¼Œæ“ä½œæ—¶ä¿¡å·é‡-1ï¼Œæ“ä½œå®Œåä¿¡å·é‡+1ï¼Œå½“ä¿¡å·é‡ç­‰äº0çš„æ—¶å€™ï¼Œå¿…é¡»ç­‰å¾…ï¼Œæ‰€ä»¥é€šè¿‡æ§åˆ¶ä¿¡å·é‡ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶èƒ½å¤ŸåŒæ—¶è¿›è¡Œçš„å¹¶å‘æ•°ã€‚

ä¿¡å·é‡æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°ï¼š

- dispatch_semaphore_createï¼šåˆ›å»ºä¸€ä¸ªä¿¡å·é‡
- dispatch_semaphore_signalï¼šä¿¡å·é‡+1
- dispatch_semaphore_waitï¼šç­‰å¾…ï¼Œç›´åˆ°ä¿¡å·é‡å¤§äº0æ—¶ï¼Œå³å¯æ“ä½œï¼ŒåŒæ—¶å°†ä¿¡å·é‡-1

```
- (void)dispatchSignal {

    // value: æœ€å¤šå‡ ä¸ªèµ„æºå¯ä»¥è®¿é—®
    long value = 2;
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(value);
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

    // ä»»åŠ¡1
    dispatch_async(queue, ^{
        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

        NSLog(@"run task 1");
        sleep(1);
        NSLog(@"complete task 1");

        dispatch_semaphore_signal(semaphore);
    });

    // ä»»åŠ¡2
    dispatch_async(queue, ^{
        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

        NSLog(@"run task 2");
        sleep(1);
        NSLog(@"complete task 2");

        dispatch_semaphore_signal(semaphore);
    });

    // ä»»åŠ¡3
    dispatch_async(queue, ^{
        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

        NSLog(@"run task 3");
        sleep(1);
        NSLog(@"complete task 3");

        dispatch_semaphore_signal(semaphore);
    });
}
```
è¿è¡Œç»“æœ
```
run task 1
run task 2
complete task 1
complete task 2
run task 3
complete task 3
```

ç”±äºè®¾å®šçš„ä¿¡å·å€¼ä¸º2ï¼Œå…ˆæ‰§è¡Œä¸¤ä¸ªçº¿ç¨‹ï¼Œç­‰æ‰§è¡Œå®Œä¸€ä¸ªï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªï¼Œä¿è¯åŒä¸€æ—¶é—´æ‰§è¡Œçš„çº¿ç¨‹æ•°ä¸è¶…è¿‡2ã€‚

å¦‚æœæˆ‘ä»¬æŠŠä¿¡å·é‡è®¾ç½®æˆ1ï¼Œ`dispatch_semaphore_create(1)` é‚£ä¹ˆæ‰§è¡Œç»“æœå°±ä¼šå˜æˆé¡ºåºæ‰§è¡Œ

```
run task 1
complete task 1
run task 2
complete task 2
run task 3
complete task 3
```

